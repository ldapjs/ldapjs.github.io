<!DOCTYPE html>
<html lang="en">
<head>
    <title>Examples | ldapjs</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" type="text/css" href="media/css/style.css">
    <link rel="stylesheet" type="text/css" href="media/css/highlight.css">
</head>
<body>
<div id="header">
    <h1>Examples | ldapjs Documentation</h1>
</div>
<div id="sidebar">

<div>Sections</div>
<span>
<ul>
<li><div><a href="index.html">Home</a></div></li>
<li><div><a href="guide.html">Guide</a></div></li>
<li><div><a href="examples.html">Examples</a></div></li>
<li><div><a href="client.html">Client API</a></div></li>
<li><div><a href="server.html">Server API</a></div></li>
<li><div><a href="dn.html">DN API</a></div></li>
<li><div><a href="filters.html">Filters API</a></div></li>
<li><div><a href="errors.html">Error API</a></div></li>
</ul>
</span>

<div>Contents</div>
</span>
<ul>
<li>
<div>
<a href="#in-memory-server">In-memory server</a>
</div>
</li>
<li>
<div>
<a href="#etcpasswd-server">/etc/passwd server</a>
</div>
</li>
<li>
<div>
<a href="#address-book">Address Book</a>
</div>
</li>
</ul>

</div>

<div id="content">
<h1 id="ldapjs-examples">ldapjs Examples</h1>
<div class="intro">

<p>This page contains a (hopefully) growing list of sample code to get you started
with ldapjs.</p>
</div>

<h1 id="in-memory-server">In-memory server</h1>
<pre><code class="language-js"><span class="hljs-keyword">const</span> ldap = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;ldapjs&#x27;</span>);


<span class="hljs-comment">///--- Shared handlers</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">authorize</span>(<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-comment">/* Any user may search after bind, only cn=root has full power */</span>
  <span class="hljs-keyword">const</span> isSearch = (req <span class="hljs-keyword">instanceof</span> ldap.SearchRequest);
  <span class="hljs-keyword">if</span> (!req.connection.ldap.bindDN.equals(<span class="hljs-string">&#x27;cn=root&#x27;</span>) &amp;&amp; !isSearch)
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.InsufficientAccessRightsError());

  <span class="hljs-keyword">return</span> next();
}


<span class="hljs-comment">///--- Globals</span>

<span class="hljs-keyword">const</span> SUFFIX = <span class="hljs-string">&#x27;o=joyent&#x27;</span>;
<span class="hljs-keyword">const</span> db = {};
<span class="hljs-keyword">const</span> server = ldap.createServer();



server.bind(<span class="hljs-string">&#x27;cn=root&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (req.dn.toString() !== <span class="hljs-string">&#x27;cn=root&#x27;</span> || req.credentials !== <span class="hljs-string">&#x27;secret&#x27;</span>)
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.InvalidCredentialsError());

  res.end();
  <span class="hljs-keyword">return</span> next();
});

server.add(SUFFIX, authorize, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> dn = req.dn.toString();

  <span class="hljs-keyword">if</span> (db[dn])
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.EntryAlreadyExistsError(dn));

  db[dn] = req.toObject().attributes;
  res.end();
  <span class="hljs-keyword">return</span> next();
});

server.bind(SUFFIX, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> dn = req.dn.toString();
  <span class="hljs-keyword">if</span> (!db[dn])
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.NoSuchObjectError(dn));

  <span class="hljs-keyword">if</span> (!db[dn].userpassword)
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.NoSuchAttributeError(<span class="hljs-string">&#x27;userPassword&#x27;</span>));

  <span class="hljs-keyword">if</span> (db[dn].userpassword.indexOf(req.credentials) === -<span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.InvalidCredentialsError());

  res.end();
  <span class="hljs-keyword">return</span> next();
});

server.compare(SUFFIX, authorize, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> dn = req.dn.toString();
  <span class="hljs-keyword">if</span> (!db[dn])
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.NoSuchObjectError(dn));

  <span class="hljs-keyword">if</span> (!db[dn][req.attribute])
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.NoSuchAttributeError(req.attribute));

  <span class="hljs-keyword">const</span> matches = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">const</span> vals = db[dn][req.attribute];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> vals) {
    <span class="hljs-keyword">if</span> (value === req.value) {
      matches = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">break</span>;
    }
  }

  res.end(matches);
  <span class="hljs-keyword">return</span> next();
});

server.del(SUFFIX, authorize, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> dn = req.dn.toString();
  <span class="hljs-keyword">if</span> (!db[dn])
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.NoSuchObjectError(dn));

  <span class="hljs-keyword">delete</span> db[dn];

  res.end();
  <span class="hljs-keyword">return</span> next();
});

server.modify(SUFFIX, authorize, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> dn = req.dn.toString();
  <span class="hljs-keyword">if</span> (!req.changes.length)
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.ProtocolError(<span class="hljs-string">&#x27;changes required&#x27;</span>));
  <span class="hljs-keyword">if</span> (!db[dn])
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.NoSuchObjectError(dn));

  <span class="hljs-keyword">const</span> entry = db[dn];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> change <span class="hljs-keyword">of</span> req.changes) {
    mod = change.modification;
    <span class="hljs-keyword">switch</span> (change.operation) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;replace&#x27;</span>:
      <span class="hljs-keyword">if</span> (!entry[mod.type])
        <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.NoSuchAttributeError(mod.type));

      <span class="hljs-keyword">if</span> (!mod.vals || !mod.vals.length) {
        <span class="hljs-keyword">delete</span> entry[mod.type];
      } <span class="hljs-keyword">else</span> {
        entry[mod.type] = mod.vals;
      }

      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;add&#x27;</span>:
      <span class="hljs-keyword">if</span> (!entry[mod.type]) {
        entry[mod.type] = mod.vals;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> v <span class="hljs-keyword">of</span> mod.vals) {
          <span class="hljs-keyword">if</span> (entry[mod.type].indexOf(v) === -<span class="hljs-number">1</span>)
            entry[mod.type].push(v);
        }
      }

      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;delete&#x27;</span>:
      <span class="hljs-keyword">if</span> (!entry[mod.type])
        <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.NoSuchAttributeError(mod.type));

      <span class="hljs-keyword">delete</span> entry[mod.type];

      <span class="hljs-keyword">break</span>;
    }
  }

  res.end();
  <span class="hljs-keyword">return</span> next();
});

server.search(SUFFIX, authorize, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> dn = req.dn.toString();
  <span class="hljs-keyword">if</span> (!db[dn])
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.NoSuchObjectError(dn));

  <span class="hljs-keyword">let</span> scopeCheck;

  <span class="hljs-keyword">switch</span> (req.scope) {
  <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;base&#x27;</span>:
    <span class="hljs-keyword">if</span> (req.filter.matches(db[dn])) {
      res.send({
        <span class="hljs-attr">dn</span>: dn,
        <span class="hljs-attr">attributes</span>: db[dn]
      });
    }

    res.end();
    <span class="hljs-keyword">return</span> next();

  <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;one&#x27;</span>:
    scopeCheck = <span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (req.dn.equals(k))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

      <span class="hljs-keyword">const</span> parent = ldap.parseDN(k).parent();
      <span class="hljs-keyword">return</span> (parent ? parent.equals(req.dn) : <span class="hljs-literal">false</span>);
    };
    <span class="hljs-keyword">break</span>;

  <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;sub&#x27;</span>:
    scopeCheck = <span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> (req.dn.equals(k) || req.dn.parentOf(k));
    };

    <span class="hljs-keyword">break</span>;
  }

  <span class="hljs-keyword">const</span> keys = <span class="hljs-built_in">Object</span>.keys(db);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> keys) {
    <span class="hljs-keyword">if</span> (!scopeCheck(key))
      <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (req.filter.matches(db[key])) {
      res.send({
        <span class="hljs-attr">dn</span>: key,
        <span class="hljs-attr">attributes</span>: db[key]
      });
    }
  }

  res.end();
  <span class="hljs-keyword">return</span> next();
});



<span class="hljs-comment">///--- Fire it up</span>

server.listen(<span class="hljs-number">1389</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;LDAP server up at: %s&#x27;</span>, server.url);
});
</code></pre>
<h1 id="etcpasswd-server">/etc/passwd server</h1>
<pre><code class="language-js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);
<span class="hljs-keyword">const</span> ldap = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;ldapjs&#x27;</span>);
<span class="hljs-keyword">const</span> { spawn } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;child_process&#x27;</span>);



<span class="hljs-comment">///--- Shared handlers</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">authorize</span>(<span class="hljs-params">req, res, next</span>) </span>{
  <span class="hljs-keyword">if</span> (!req.connection.ldap.bindDN.equals(<span class="hljs-string">&#x27;cn=root&#x27;</span>))
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.InsufficientAccessRightsError());

  <span class="hljs-keyword">return</span> next();
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadPasswdFile</span>(<span class="hljs-params">req, res, next</span>) </span>{
  fs.readFile(<span class="hljs-string">&#x27;/etc/passwd&#x27;</span>, <span class="hljs-string">&#x27;utf8&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (err)
      <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.OperationsError(err.message));

    req.users = {};

    <span class="hljs-keyword">const</span> lines = data.split(<span class="hljs-string">&#x27;\n&#x27;</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
      <span class="hljs-keyword">if</span> (!line || <span class="hljs-regexp">/^#/</span>.test(line))
        <span class="hljs-keyword">continue</span>;

      <span class="hljs-keyword">const</span> record = line.split(<span class="hljs-string">&#x27;:&#x27;</span>);
      <span class="hljs-keyword">if</span> (!record || !record.length)
        <span class="hljs-keyword">continue</span>;

      req.users[record[<span class="hljs-number">0</span>]] = {
        <span class="hljs-attr">dn</span>: <span class="hljs-string">&#x27;cn=&#x27;</span> + record[<span class="hljs-number">0</span>] + <span class="hljs-string">&#x27;, ou=users, o=myhost&#x27;</span>,
        <span class="hljs-attr">attributes</span>: {
          <span class="hljs-attr">cn</span>: record[<span class="hljs-number">0</span>],
          <span class="hljs-attr">uid</span>: record[<span class="hljs-number">2</span>],
          <span class="hljs-attr">gid</span>: record[<span class="hljs-number">3</span>],
          <span class="hljs-attr">description</span>: record[<span class="hljs-number">4</span>],
          <span class="hljs-attr">homedirectory</span>: record[<span class="hljs-number">5</span>],
          <span class="hljs-attr">shell</span>: record[<span class="hljs-number">6</span>] || <span class="hljs-string">&#x27;&#x27;</span>,
          <span class="hljs-attr">objectclass</span>: <span class="hljs-string">&#x27;unixUser&#x27;</span>
        }
      };
    }

    <span class="hljs-keyword">return</span> next();
  });
}


<span class="hljs-keyword">const</span> pre = [authorize, loadPasswdFile];



<span class="hljs-comment">///--- Mainline</span>

<span class="hljs-keyword">const</span> server = ldap.createServer();

server.bind(<span class="hljs-string">&#x27;cn=root&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (req.dn.toString() !== <span class="hljs-string">&#x27;cn=root&#x27;</span> || req.credentials !== <span class="hljs-string">&#x27;secret&#x27;</span>)
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.InvalidCredentialsError());

  res.end();
  <span class="hljs-keyword">return</span> next();
});


server.add(<span class="hljs-string">&#x27;ou=users, o=myhost&#x27;</span>, pre, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!req.dn.rdns[<span class="hljs-number">0</span>].cn)
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.ConstraintViolationError(<span class="hljs-string">&#x27;cn required&#x27;</span>));

  <span class="hljs-keyword">if</span> (req.users[req.dn.rdns[<span class="hljs-number">0</span>].cn])
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.EntryAlreadyExistsError(req.dn.toString()));

  <span class="hljs-keyword">const</span> entry = req.toObject().attributes;

  <span class="hljs-keyword">if</span> (entry.objectclass.indexOf(<span class="hljs-string">&#x27;unixUser&#x27;</span>) === -<span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.ConstraintViolationError(<span class="hljs-string">&#x27;entry must be a unixUser&#x27;</span>));

  <span class="hljs-keyword">const</span> opts = [<span class="hljs-string">&#x27;-m&#x27;</span>];
  <span class="hljs-keyword">if</span> (entry.description) {
    opts.push(<span class="hljs-string">&#x27;-c&#x27;</span>);
    opts.push(entry.description[<span class="hljs-number">0</span>]);
  }
  <span class="hljs-keyword">if</span> (entry.homedirectory) {
    opts.push(<span class="hljs-string">&#x27;-d&#x27;</span>);
    opts.push(entry.homedirectory[<span class="hljs-number">0</span>]);
  }
  <span class="hljs-keyword">if</span> (entry.gid) {
    opts.push(<span class="hljs-string">&#x27;-g&#x27;</span>);
    opts.push(entry.gid[<span class="hljs-number">0</span>]);
  }
  <span class="hljs-keyword">if</span> (entry.shell) {
    opts.push(<span class="hljs-string">&#x27;-s&#x27;</span>);
    opts.push(entry.shell[<span class="hljs-number">0</span>]);
  }
  <span class="hljs-keyword">if</span> (entry.uid) {
    opts.push(<span class="hljs-string">&#x27;-u&#x27;</span>);
    opts.push(entry.uid[<span class="hljs-number">0</span>]);
  }
  opts.push(entry.cn[<span class="hljs-number">0</span>]);
  <span class="hljs-keyword">const</span> useradd = spawn(<span class="hljs-string">&#x27;useradd&#x27;</span>, opts);

  <span class="hljs-keyword">const</span> messages = [];

  useradd.stdout.on(<span class="hljs-string">&#x27;data&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    messages.push(data.toString());
  });
  useradd.stderr.on(<span class="hljs-string">&#x27;data&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    messages.push(data.toString());
  });

  useradd.on(<span class="hljs-string">&#x27;exit&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">code</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (code !== <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">let</span> msg = <span class="hljs-string">&#x27;&#x27;</span> + code;
      <span class="hljs-keyword">if</span> (messages.length)
        msg += <span class="hljs-string">&#x27;: &#x27;</span> + messages.join();
      <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.OperationsError(msg));
    }

    res.end();
    <span class="hljs-keyword">return</span> next();
  });
});


server.modify(<span class="hljs-string">&#x27;ou=users, o=myhost&#x27;</span>, pre, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!req.dn.rdns[<span class="hljs-number">0</span>].cn || !req.users[req.dn.rdns[<span class="hljs-number">0</span>].cn])
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.NoSuchObjectError(req.dn.toString()));

  <span class="hljs-keyword">if</span> (!req.changes.length)
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.ProtocolError(<span class="hljs-string">&#x27;changes required&#x27;</span>));

  <span class="hljs-keyword">const</span> user = req.users[req.dn.rdns[<span class="hljs-number">0</span>].cn].attributes;
  <span class="hljs-keyword">let</span> mod;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> change <span class="hljs-keyword">of</span> req.changes) {
    mod = change.modification;
    <span class="hljs-keyword">switch</span> (change.operation) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;replace&#x27;</span>:
      <span class="hljs-keyword">if</span> (mod.type !== <span class="hljs-string">&#x27;userpassword&#x27;</span> || !mod.vals || !mod.vals.length)
        <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.UnwillingToPerformError(<span class="hljs-string">&#x27;only password updates &#x27;</span> +
                                                     <span class="hljs-string">&#x27;allowed&#x27;</span>));
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;add&#x27;</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;delete&#x27;</span>:
      <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.UnwillingToPerformError(<span class="hljs-string">&#x27;only replace allowed&#x27;</span>));
    }
  }

  <span class="hljs-keyword">const</span> passwd = spawn(<span class="hljs-string">&#x27;chpasswd&#x27;</span>, [<span class="hljs-string">&#x27;-c&#x27;</span>, <span class="hljs-string">&#x27;MD5&#x27;</span>]);
  passwd.stdin.end(user.cn + <span class="hljs-string">&#x27;:&#x27;</span> + mod.vals[<span class="hljs-number">0</span>], <span class="hljs-string">&#x27;utf8&#x27;</span>);

  passwd.on(<span class="hljs-string">&#x27;exit&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">code</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (code !== <span class="hljs-number">0</span>)
      <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.OperationsError(<span class="hljs-string">&#x27;&#x27;</span> + code));

    res.end();
    <span class="hljs-keyword">return</span> next();
  });
});


server.del(<span class="hljs-string">&#x27;ou=users, o=myhost&#x27;</span>, pre, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!req.dn.rdns[<span class="hljs-number">0</span>].cn || !req.users[req.dn.rdns[<span class="hljs-number">0</span>].cn])
    <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.NoSuchObjectError(req.dn.toString()));

  <span class="hljs-keyword">const</span> userdel = spawn(<span class="hljs-string">&#x27;userdel&#x27;</span>, [<span class="hljs-string">&#x27;-f&#x27;</span>, req.dn.rdns[<span class="hljs-number">0</span>].cn]);

  <span class="hljs-keyword">const</span> messages = [];
  userdel.stdout.on(<span class="hljs-string">&#x27;data&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    messages.push(data.toString());
  });
  userdel.stderr.on(<span class="hljs-string">&#x27;data&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    messages.push(data.toString());
  });

  userdel.on(<span class="hljs-string">&#x27;exit&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">code</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (code !== <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">let</span> msg = <span class="hljs-string">&#x27;&#x27;</span> + code;
      <span class="hljs-keyword">if</span> (messages.length)
        msg += <span class="hljs-string">&#x27;: &#x27;</span> + messages.join();
      <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.OperationsError(msg));
    }

    res.end();
    <span class="hljs-keyword">return</span> next();
  });
});


server.search(<span class="hljs-string">&#x27;o=myhost&#x27;</span>, pre, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> keys = <span class="hljs-built_in">Object</span>.keys(req.users);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k <span class="hljs-keyword">of</span> keys) {
    <span class="hljs-keyword">if</span> (req.filter.matches(req.users[k].attributes))
      res.send(req.users[k]);
  }

  res.end();
  <span class="hljs-keyword">return</span> next();
});



<span class="hljs-comment">// LDAP &quot;standard&quot; listens on 389, but whatever.</span>
server.listen(<span class="hljs-number">1389</span>, <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;/etc/passwd LDAP server up at: %s&#x27;</span>, server.url);
});
</code></pre>
<h1 id="address-book">Address Book</h1>
<p>This example is courtesy of <a href="https://github.com/dresende">Diogo Resende</a> and
illustrates setting up an address book for typical mail clients such as
Thunderbird or Evolution over a MySQL database.</p>
<pre><code class="language-js"><span class="hljs-comment">// MySQL test: (create on database &#x27;abook&#x27; with username &#x27;abook&#x27; and password &#x27;abook&#x27;)</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// CREATE TABLE IF NOT EXISTS `users` (</span>
<span class="hljs-comment">//   `id` int(5) unsigned NOT NULL AUTO_INCREMENT,</span>
<span class="hljs-comment">//   `username` varchar(50) NOT NULL,</span>
<span class="hljs-comment">//   `password` varchar(50) NOT NULL,</span>
<span class="hljs-comment">//   PRIMARY KEY (`id`),</span>
<span class="hljs-comment">//   KEY `username` (`username`)</span>
<span class="hljs-comment">// ) ENGINE=InnoDB  DEFAULT CHARSET=utf8;</span>
<span class="hljs-comment">// INSERT INTO `users` (`username`, `password`) VALUES</span>
<span class="hljs-comment">// (&#x27;demo&#x27;, &#x27;demo&#x27;);</span>
<span class="hljs-comment">// CREATE TABLE IF NOT EXISTS `contacts` (</span>
<span class="hljs-comment">//   `id` int(5) unsigned NOT NULL AUTO_INCREMENT,</span>
<span class="hljs-comment">//   `user_id` int(5) unsigned NOT NULL,</span>
<span class="hljs-comment">//   `name` varchar(100) NOT NULL,</span>
<span class="hljs-comment">//   `email` varchar(255) NOT NULL,</span>
<span class="hljs-comment">//   PRIMARY KEY (`id`),</span>
<span class="hljs-comment">//   KEY `user_id` (`user_id`)</span>
<span class="hljs-comment">// ) ENGINE=InnoDB  DEFAULT CHARSET=utf8;</span>
<span class="hljs-comment">// INSERT INTO `contacts` (`user_id`, `name`, `email`) VALUES</span>
<span class="hljs-comment">// (1, &#x27;John Doe&#x27;, &#x27;john.doe@example.com&#x27;),</span>
<span class="hljs-comment">// (1, &#x27;Jane Doe&#x27;, &#x27;jane.doe@example.com&#x27;);</span>
<span class="hljs-comment">//</span>

<span class="hljs-keyword">const</span> ldap = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;ldapjs&#x27;</span>);
<span class="hljs-keyword">const</span> mysql = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;mysql&quot;</span>);
<span class="hljs-keyword">const</span> server = ldap.createServer();
<span class="hljs-keyword">const</span> addrbooks = {};
<span class="hljs-keyword">const</span> userinfo = {};
<span class="hljs-keyword">const</span> ldap_port = <span class="hljs-number">389</span>;
<span class="hljs-keyword">const</span> basedn = <span class="hljs-string">&quot;dc=example, dc=com&quot;</span>;
<span class="hljs-keyword">const</span> company = <span class="hljs-string">&quot;Example&quot;</span>;
<span class="hljs-keyword">const</span> db = mysql.createClient({
  <span class="hljs-attr">user</span>: <span class="hljs-string">&quot;abook&quot;</span>,
  <span class="hljs-attr">password</span>: <span class="hljs-string">&quot;abook&quot;</span>,
  <span class="hljs-attr">database</span>: <span class="hljs-string">&quot;abook&quot;</span>
});

db.query(<span class="hljs-string">&quot;SELECT c.*,u.username,u.password &quot;</span> +
         <span class="hljs-string">&quot;FROM contacts c JOIN users u ON c.user_id=u.id&quot;</span>,
         <span class="hljs-function">(<span class="hljs-params">err, contacts</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Error fetching contacts&quot;</span>, err);
    process.exit(<span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> contact <span class="hljs-keyword">of</span> contacts) {
    <span class="hljs-keyword">if</span> (!addrbooks.hasOwnProperty(contact.username)) {
      addrbooks[contact.username] = [];
      userinfo[<span class="hljs-string">&quot;cn=&quot;</span> + contact.username + <span class="hljs-string">&quot;, &quot;</span> + basedn] = {
        <span class="hljs-attr">abook</span>: addrbooks[contact.username],
        <span class="hljs-attr">pwd</span>: contact.password
      };
    }

    <span class="hljs-keyword">const</span> p = contact.name.indexOf(<span class="hljs-string">&quot; &quot;</span>);
    <span class="hljs-keyword">if</span> (p != -<span class="hljs-number">1</span>)
      contact.firstname = contact.name.substr(<span class="hljs-number">0</span>, p);

    p = contact.name.lastIndexOf(<span class="hljs-string">&quot; &quot;</span>);
    <span class="hljs-keyword">if</span> (p != -<span class="hljs-number">1</span>)
      contact.surname = contact.name.substr(p + <span class="hljs-number">1</span>);

    addrbooks[contact.username].push({
      <span class="hljs-attr">dn</span>: <span class="hljs-string">&quot;cn=&quot;</span> + contact.name + <span class="hljs-string">&quot;, &quot;</span> + basedn,
      <span class="hljs-attr">attributes</span>: {
        <span class="hljs-attr">objectclass</span>: [ <span class="hljs-string">&quot;top&quot;</span> ],
        <span class="hljs-attr">cn</span>: contact.name,
        <span class="hljs-attr">mail</span>: contact.email,
        <span class="hljs-attr">givenname</span>: contact.firstname,
        <span class="hljs-attr">sn</span>: contact.surname,
        <span class="hljs-attr">ou</span>: company
      }
    });
  }

  server.bind(basedn, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> username = req.dn.toString();
    <span class="hljs-keyword">const</span> password = req.credentials;

    <span class="hljs-keyword">if</span> (!userinfo.hasOwnProperty(username) ||
         userinfo[username].pwd != password) {
      <span class="hljs-keyword">return</span> next(<span class="hljs-keyword">new</span> ldap.InvalidCredentialsError());
    }

    res.end();
    <span class="hljs-keyword">return</span> next();
  });

  server.search(basedn, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> binddn = req.connection.ldap.bindDN.toString();

    <span class="hljs-keyword">if</span> (userinfo.hasOwnProperty(binddn)) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> abook <span class="hljs-keyword">of</span> userinfo[binddn].abook) {
        <span class="hljs-keyword">if</span> (req.filter.matches(abook.attributes))
          res.send(abook);
      }
    }
    res.end();
  });

  server.listen(ldap_port, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Addressbook started at %s&quot;</span>, server.url);
  });
});
</code></pre>
<p>To test out this example, try:</p>
<pre><code class="language-shell"><span class="hljs-meta">$</span><span class="bash"> ldapsearch -H ldap://localhost:389 -x -D cn=demo,dc=example,dc=com \
  -w demo -b <span class="hljs-string">&quot;dc=example,dc=com&quot;</span> objectclass=*</span>
</code></pre>

</div><!-- end #content -->

</body>
</html>
