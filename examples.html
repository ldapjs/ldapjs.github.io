<!DOCTYPE html>
<html lang="en">
<head>
    <title>Examples | ldapjs</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" type="text/css" href="media/css/style.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
</head>
<body>
<div id="header">
    <h1>Examples | ldapjs Documentation</h1>
</div>
<div id="sidebar">

<div>Sections</div>
<span>
<ul>
<li><div><a href="index.html">Home</a></div></li>
<li><div><a href="guide.html">Guide</a></div></li>
<li><div><a href="examples.html">Examples</a></div></li>
<li><div><a href="client.html">Client API</a></div></li>
<li><div><a href="server.html">Server API</a></div></li>
<li><div><a href="dn.html">DN API</a></div></li>
<li><div><a href="filters.html">Filters API</a></div></li>
<li><div><a href="errors.html">Error API</a></div></li>
</ul>
</span>

<div>Contents</div>
</span>
<ul>
<li>
<div>
<a href="#in-memory-server">In-memory server</a>
</div>
</li>
<li>
<div>
<a href="#etcpasswd-server">/etc/passwd server</a>
</div>
</li>
<li>
<div>
<a href="#address-book">Address Book</a>
</div>
</li>
</ul>

</div>

<div id="content">
<h1 id="ldapjs-examples">ldapjs Examples</h1>
<div class="intro">

<p>This page contains a (hopefully) growing list of sample code to get you started
with ldapjs.</p>
</div>

<h1 id="in-memory-server">In-memory server</h1>
<pre><code>var ldap = require(&#39;ldapjs&#39;);


///--- Shared handlers

function authorize(req, res, next) {
  /* Any user may search after bind, only cn=root has full power */
  var isSearch = (req instanceof ldap.SearchRequest);
  if (!req.connection.ldap.bindDN.equals(&#39;cn=root&#39;) &amp;&amp; !isSearch)
    return next(new ldap.InsufficientAccessRightsError());

  return next();
}


///--- Globals

var SUFFIX = &#39;o=joyent&#39;;
var db = {};
var server = ldap.createServer();



server.bind(&#39;cn=root&#39;, function(req, res, next) {
  if (req.dn.toString() !== &#39;cn=root&#39; || req.credentials !== &#39;secret&#39;)
    return next(new ldap.InvalidCredentialsError());

  res.end();
  return next();
});

server.add(SUFFIX, authorize, function(req, res, next) {
  var dn = req.dn.toString();

  if (db[dn])
    return next(new ldap.EntryAlreadyExistsError(dn));

  db[dn] = req.toObject().attributes;
  res.end();
  return next();
});

server.bind(SUFFIX, function(req, res, next) {
  var dn = req.dn.toString();
  if (!db[dn])
    return next(new ldap.NoSuchObjectError(dn));

  if (!db[dn].userpassword)
    return next(new ldap.NoSuchAttributeError(&#39;userPassword&#39;));

  if (db[dn].userpassword.indexOf(req.credentials) === -1)
    return next(new ldap.InvalidCredentialsError());

  res.end();
  return next();
});

server.compare(SUFFIX, authorize, function(req, res, next) {
  var dn = req.dn.toString();
  if (!db[dn])
    return next(new ldap.NoSuchObjectError(dn));

  if (!db[dn][req.attribute])
    return next(new ldap.NoSuchAttributeError(req.attribute));

  var matches = false;
  var vals = db[dn][req.attribute];
  for (var i = 0; i &lt; vals.length; i++) {
    if (vals[i] === req.value) {
      matches = true;
      break;
    }
  }

  res.end(matches);
  return next();
});

server.del(SUFFIX, authorize, function(req, res, next) {
  var dn = req.dn.toString();
  if (!db[dn])
    return next(new ldap.NoSuchObjectError(dn));

  delete db[dn];

  res.end();
  return next();
});

server.modify(SUFFIX, authorize, function(req, res, next) {
  var dn = req.dn.toString();
  if (!req.changes.length)
    return next(new ldap.ProtocolError(&#39;changes required&#39;));
  if (!db[dn])
    return next(new ldap.NoSuchObjectError(dn));

  var entry = db[dn];

  for (var i = 0; i &lt; req.changes.length; i++) {
    mod = req.changes[i].modification;
    switch (req.changes[i].operation) {
    case &#39;replace&#39;:
      if (!entry[mod.type])
        return next(new ldap.NoSuchAttributeError(mod.type));

      if (!mod.vals || !mod.vals.length) {
        delete entry[mod.type];
      } else {
        entry[mod.type] = mod.vals;
      }

      break;

    case &#39;add&#39;:
      if (!entry[mod.type]) {
        entry[mod.type] = mod.vals;
      } else {
        mod.vals.forEach(function(v) {
          if (entry[mod.type].indexOf(v) === -1)
            entry[mod.type].push(v);
        });
      }

      break;

    case &#39;delete&#39;:
      if (!entry[mod.type])
        return next(new ldap.NoSuchAttributeError(mod.type));

      delete entry[mod.type];

      break;
    }
  }

  res.end();
  return next();
});

server.search(SUFFIX, authorize, function(req, res, next) {
  var dn = req.dn.toString();
  if (!db[dn])
    return next(new ldap.NoSuchObjectError(dn));

  var scopeCheck;

  switch (req.scope) {
  case &#39;base&#39;:
    if (req.filter.matches(db[dn])) {
      res.send({
        dn: dn,
        attributes: db[dn]
      });
    }

    res.end();
    return next();

  case &#39;one&#39;:
    scopeCheck = function(k) {
      if (req.dn.equals(k))
        return true;

      var parent = ldap.parseDN(k).parent();
      return (parent ? parent.equals(req.dn) : false);
    };
    break;

  case &#39;sub&#39;:
    scopeCheck = function(k) {
      return (req.dn.equals(k) || req.dn.parentOf(k));
    };

    break;
  }

  Object.keys(db).forEach(function(key) {
    if (!scopeCheck(key))
      return;

    if (req.filter.matches(db[key])) {
      res.send({
        dn: key,
        attributes: db[key]
      });
    }
  });

  res.end();
  return next();
});



///--- Fire it up

server.listen(1389, function() {
  console.log(&#39;LDAP server up at: %s&#39;, server.url);
});
</code></pre>
<h1 id="etcpasswd-server">/etc/passwd server</h1>
<pre><code>var fs = require(&#39;fs&#39;);
var ldap = require(&#39;ldapjs&#39;);
var spawn = require(&#39;child_process&#39;).spawn;



///--- Shared handlers

function authorize(req, res, next) {
  if (!req.connection.ldap.bindDN.equals(&#39;cn=root&#39;))
    return next(new ldap.InsufficientAccessRightsError());

  return next();
}


function loadPasswdFile(req, res, next) {
  fs.readFile(&#39;/etc/passwd&#39;, &#39;utf8&#39;, function(err, data) {
    if (err)
      return next(new ldap.OperationsError(err.message));

    req.users = {};

    var lines = data.split(&#39;\n&#39;);
    for (var i = 0; i &lt; lines.length; i++) {
      if (!lines[i] || /^#/.test(lines[i]))
        continue;

      var record = lines[i].split(&#39;:&#39;);
      if (!record || !record.length)
        continue;

      req.users[record[0]] = {
        dn: &#39;cn=&#39; + record[0] + &#39;, ou=users, o=myhost&#39;,
        attributes: {
          cn: record[0],
          uid: record[2],
          gid: record[3],
          description: record[4],
          homedirectory: record[5],
          shell: record[6] || &#39;&#39;,
          objectclass: &#39;unixUser&#39;
        }
      };
    }

    return next();
  });
}


var pre = [authorize, loadPasswdFile];



///--- Mainline

var server = ldap.createServer();

server.bind(&#39;cn=root&#39;, function(req, res, next) {
  if (req.dn.toString() !== &#39;cn=root&#39; || req.credentials !== &#39;secret&#39;)
    return next(new ldap.InvalidCredentialsError());

  res.end();
  return next();
});


server.add(&#39;ou=users, o=myhost&#39;, pre, function(req, res, next) {
  if (!req.dn.rdns[0].cn)
    return next(new ldap.ConstraintViolationError(&#39;cn required&#39;));

  if (req.users[req.dn.rdns[0].cn])
    return next(new ldap.EntryAlreadyExistsError(req.dn.toString()));

  var entry = req.toObject().attributes;

  if (entry.objectclass.indexOf(&#39;unixUser&#39;) === -1)
    return next(new ldap.ConstraintViolationError(&#39;entry must be a unixUser&#39;));

  var opts = [&#39;-m&#39;];
  if (entry.description) {
    opts.push(&#39;-c&#39;);
    opts.push(entry.description[0]);
  }
  if (entry.homedirectory) {
    opts.push(&#39;-d&#39;);
    opts.push(entry.homedirectory[0]);
  }
  if (entry.gid) {
    opts.push(&#39;-g&#39;);
    opts.push(entry.gid[0]);
  }
  if (entry.shell) {
    opts.push(&#39;-s&#39;);
    opts.push(entry.shell[0]);
  }
  if (entry.uid) {
    opts.push(&#39;-u&#39;);
    opts.push(entry.uid[0]);
  }
  opts.push(entry.cn[0]);
  var useradd = spawn(&#39;useradd&#39;, opts);

  var messages = [];

  useradd.stdout.on(&#39;data&#39;, function(data) {
    messages.push(data.toString());
  });
  useradd.stderr.on(&#39;data&#39;, function(data) {
    messages.push(data.toString());
  });

  useradd.on(&#39;exit&#39;, function(code) {
    if (code !== 0) {
      var msg = &#39;&#39; + code;
      if (messages.length)
        msg += &#39;: &#39; + messages.join();
      return next(new ldap.OperationsError(msg));
    }

    res.end();
    return next();
  });
});


server.modify(&#39;ou=users, o=myhost&#39;, pre, function(req, res, next) {
  if (!req.dn.rdns[0].cn || !req.users[req.dn.rdns[0].cn])
    return next(new ldap.NoSuchObjectError(req.dn.toString()));

  if (!req.changes.length)
    return next(new ldap.ProtocolError(&#39;changes required&#39;));

  var user = req.users[req.dn.rdns[0].cn].attributes;
  var mod;

  for (var i = 0; i &lt; req.changes.length; i++) {
    mod = req.changes[i].modification;
    switch (req.changes[i].operation) {
    case &#39;replace&#39;:
      if (mod.type !== &#39;userpassword&#39; || !mod.vals || !mod.vals.length)
        return next(new ldap.UnwillingToPerformError(&#39;only password updates &#39; +
                                                     &#39;allowed&#39;));
      break;
    case &#39;add&#39;:
    case &#39;delete&#39;:
      return next(new ldap.UnwillingToPerformError(&#39;only replace allowed&#39;));
    }
  }

  var passwd = spawn(&#39;chpasswd&#39;, [&#39;-c&#39;, &#39;MD5&#39;]);
  passwd.stdin.end(user.cn + &#39;:&#39; + mod.vals[0], &#39;utf8&#39;);

  passwd.on(&#39;exit&#39;, function(code) {
    if (code !== 0)
      return next(new ldap.OperationsError(&#39;&#39; + code));

    res.end();
    return next();
  });
});


server.del(&#39;ou=users, o=myhost&#39;, pre, function(req, res, next) {
  if (!req.dn.rdns[0].cn || !req.users[req.dn.rdns[0].cn])
    return next(new ldap.NoSuchObjectError(req.dn.toString()));

  var userdel = spawn(&#39;userdel&#39;, [&#39;-f&#39;, req.dn.rdns[0].cn]);

  var messages = [];
  userdel.stdout.on(&#39;data&#39;, function(data) {
    messages.push(data.toString());
  });
  userdel.stderr.on(&#39;data&#39;, function(data) {
    messages.push(data.toString());
  });

  userdel.on(&#39;exit&#39;, function(code) {
    if (code !== 0) {
      var msg = &#39;&#39; + code;
      if (messages.length)
        msg += &#39;: &#39; + messages.join();
      return next(new ldap.OperationsError(msg));
    }

    res.end();
    return next();
  });
});


server.search(&#39;o=myhost&#39;, pre, function(req, res, next) {
  Object.keys(req.users).forEach(function(k) {
    if (req.filter.matches(req.users[k].attributes))
      res.send(req.users[k]);
  });

  res.end();
  return next();
});



// LDAP &quot;standard&quot; listens on 389, but whatever.
server.listen(1389, &#39;127.0.0.1&#39;, function() {
  console.log(&#39;/etc/passwd LDAP server up at: %s&#39;, server.url);
});
</code></pre>
<h1 id="address-book">Address Book</h1>
<p>This example is courtesy of <a href="https://github.com/dresende">Diogo Resende</a> and
illustrates setting up an address book for typical mail clients such as
Thunderbird or Evolution over a MySQL database.</p>
<pre><code>// MySQL test: (create on database &#39;abook&#39; with username &#39;abook&#39; and password &#39;abook&#39;)
//
// CREATE TABLE IF NOT EXISTS `users` (
//   `id` int(5) unsigned NOT NULL AUTO_INCREMENT,
//   `username` varchar(50) NOT NULL,
//   `password` varchar(50) NOT NULL,
//   PRIMARY KEY (`id`),
//   KEY `username` (`username`)
// ) ENGINE=InnoDB  DEFAULT CHARSET=utf8;
// INSERT INTO `users` (`username`, `password`) VALUES
// (&#39;demo&#39;, &#39;demo&#39;);
// CREATE TABLE IF NOT EXISTS `contacts` (
//   `id` int(5) unsigned NOT NULL AUTO_INCREMENT,
//   `user_id` int(5) unsigned NOT NULL,
//   `name` varchar(100) NOT NULL,
//   `email` varchar(255) NOT NULL,
//   PRIMARY KEY (`id`),
//   KEY `user_id` (`user_id`)
// ) ENGINE=InnoDB  DEFAULT CHARSET=utf8;
// INSERT INTO `contacts` (`user_id`, `name`, `email`) VALUES
// (1, &#39;John Doe&#39;, &#39;john.doe@example.com&#39;),
// (1, &#39;Jane Doe&#39;, &#39;jane.doe@example.com&#39;);
//

var ldap = require(&#39;ldapjs&#39;),
    mysql = require(&quot;mysql&quot;),
    server = ldap.createServer(),
    addrbooks = {}, userinfo = {},
    ldap_port = 389,
    basedn = &quot;dc=example, dc=com&quot;,
    company = &quot;Example&quot;,
    db = mysql.createClient({
      user: &quot;abook&quot;,
      password: &quot;abook&quot;,
      database: &quot;abook&quot;
    });

db.query(&quot;SELECT c.*,u.username,u.password &quot; +
         &quot;FROM contacts c JOIN users u ON c.user_id=u.id&quot;,
         function(err, contacts) {
  if (err) {
    console.log(&quot;Error fetching contacts&quot;, err);
    process.exit(1);
  }

  for (var i = 0; i &lt; contacts.length; i++) {
    if (!addrbooks.hasOwnProperty(contacts[i].username)) {
      addrbooks[contacts[i].username] = [];
      userinfo[&quot;cn=&quot; + contacts[i].username + &quot;, &quot; + basedn] = {
        abook: addrbooks[contacts[i].username],
        pwd: contacts[i].password
      };
    }

    var p = contacts[i].name.indexOf(&quot; &quot;);
    if (p != -1)
      contacts[i].firstname = contacts[i].name.substr(0, p);

    p = contacts[i].name.lastIndexOf(&quot; &quot;);
    if (p != -1)
      contacts[i].surname = contacts[i].name.substr(p + 1);

    addrbooks[contacts[i].username].push({
      dn: &quot;cn=&quot; + contacts[i].name + &quot;, &quot; + basedn,
      attributes: {
        objectclass: [ &quot;top&quot; ],
        cn: contacts[i].name,
        mail: contacts[i].email,
        givenname: contacts[i].firstname,
        sn: contacts[i].surname,
        ou: company
      }
    });
  }

  server.bind(basedn, function (req, res, next) {
    var username = req.dn.toString(),
        password = req.credentials;

    if (!userinfo.hasOwnProperty(username) ||
         userinfo[username].pwd != password) {
      return next(new ldap.InvalidCredentialsError());
    }

    res.end();
    return next();
  });

  server.search(basedn, function(req, res, next) {
    var binddn = req.connection.ldap.bindDN.toString();

    if (userinfo.hasOwnProperty(binddn)) {
      for (var i = 0; i &lt; userinfo[binddn].abook.length; i++) {
        if (req.filter.matches(userinfo[binddn].abook[i].attributes))
          res.send(userinfo[binddn].abook[i]);
      }
    }
    res.end();
  });

  server.listen(ldap_port, function() {
    console.log(&quot;Addressbook started at %s&quot;, server.url);
  });
});
</code></pre>
<p>To test out this example, try:</p>
<pre><code>$ ldapsearch -H ldap://localhost:389 -x -D cn=demo,dc=example,dc=com \
  -w demo -b &quot;dc=example,dc=com&quot; objectclass=*
</code></pre>
</div><!-- end #content -->

<script type="text/javascript" charset="utf-8">
$(function() {
    var headerHeight = $("#header").height();
    var offsets = [];
    var current = -1;

    function endpoint(scrollDistance) {
        if (scrollDistance < offsets[0]) {
            return -1;
        } else {
            for (var id = offsets.length; id > 0; id--) {
                if (scrollDistance > offsets[id - 1]) {
                    return id - 1;
                    break;
                }
            }
        }
    }

    $("h2").each(function(i) {
        offsets.push($(this).offset().top - headerHeight)
    });

    $("#content").append('<h2 class="fixed" style="display: none"><span>&nbsp;</span></h2>');
    var fixed_h2 = $("h2.fixed");
    var fixed_span = $("h2.fixed span");

    $("#content").scroll(function() {
        var scrollDistance = $("#content").attr('scrollTop');
        var now = endpoint(scrollDistance);

        if (now !== current) {
            $("#sidebar li").removeClass("current");
            current = now;
            if (current < 0) {
                fixed_h2.hide();
            } else if (current >= 0) {
                var heading = $($("h2 span")[current]).text();
                $("#sidebar a[href|=#" + heading.replace(' ', '-') + "]").parent().addClass("current");
                fixed_span.text(heading);
                fixed_h2.show();
            }
        }
    });
});
</script>

</body>
</html>
